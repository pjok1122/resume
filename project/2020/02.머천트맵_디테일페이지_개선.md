## Merchant Map 상세 페이지 개편 Phase 1

### 일정

- 개발 기간 : 20.09.25 ~ 20.12.23
- 투입 인력 : 1인
- Release : 2020.12.23 배포

### 서비스 간략 정리

- `Merchant map`은 라인페이를 지원하는 가맹점의 정보를 볼 수 있는 웹앱 서비스이며, 일본, 대만, 태국 세 국가에 대해서 서비스를 지원하고 있음.
- `Merchant Center`에서 실제 가맹점의 등록, 수정 등을 관리하며, `Merchant Center`에서 등록된 가맹점을 `Merchant map`에 점포로 노출할 것인지에 대한 정보를 가지고 있다. 하나의 가맹점주는 맵에 노출되는 여러 개의 점포를 보유할 수 있다. (xx 고깃집 1호점, xx 고깃집 2호점)

### 기획

- 머천트 맵의 기능을 단순히 라인페이를 지원하는 가맹점을 확인하는 용도 뿐 아니라, 네이버 지도처럼 판매 상품, 이미지, 주변 가맹점 등 부가적인 정보를 추가하길 원함.
- 모든 국가에 동일하게 적용하는 것이 아니라, 대만에서만 개편 진행. (대만에서 가맹점 사업 쪽에 매진하고 있기 때문에 발 맞추어 개발 진행.)
- `Merchant center`에서 가맹점에 대한 정보를 입력 받을 때 추가적인 정보를 받을 수 있도록 수정.

### 회고

#### 프로토콜 결정

머천트맵 개발을 하기 전에는 다른 팀과의 관계는 신경 쓸 이유가 없었다. 하지만 머천트맵은 점포를 등록하는 시점에 다른 컴포넌트와 통신이 많이 이뤄져서 다른 팀과의 협업에 대해서 처음으로 생각해보게 되었다. 머천트맵에 점포를 등록하는 로직은 다음과 같다. 
merchant-center -> Kafka -> consumer -> map-api. 여기서 `merchant center`는 외주(NTS)에서 개발하는 컴포넌트이고 kafka와 consumer는 Dev2 컴포넌트이다. 신규 기능은 점포에 새로운 데이터를 추가적으로 노출하는 것이기 때문에 NTS와 프로토콜을 정의해야만 했다. NTS는 외주 개발자이므로 Queue에 대한 변경 권한이 없으므로, 우리 팀에서 프로토콜을 결정해야 하는 입장이었다. 판매 아이템 같은 정보는 별도의 topic을 만들까에 대한 생각도 들었지만, 여기저기서 컨슘할 여지가 없다고 생각하여 기존 DTO 안에 필드로 추가해두었고, 점포에 대한 작은 추가 정보들도 DTO의 필드로 추가했다. 또, 이 필드들은 대만에서만 추가되어야 하므로, 점포등록V2 API를 설계하고 kafka consume 할 때 국가에 맞게 v1, v2 API를 호출하도록 분기처리하도록 변경했다. 여러 컴포넌트에 걸쳐서 통신하는 프로토콜을 정의해볼 수 있는 좋은 경험이었다.

#### Front API 개발

처음으로 Front API 개발과 문서를 작성하게 됐다. 다른 개발팀과 직접적으로 소통이 필요하게 된 것은 이때가 처음이다. 기존에 혼자 Rest API를 만들고 통신해본 경험은 있어 개발 자체는 그다지 어렵지 않았다. 하지만 문서화를 하는 것은 처음이라 조금은 어색하고 불안했다. 나의 우려와는 다르게 문서는 기존 포맷대로 작성하면 됐고, Web 개발 팀에서는 문제 없이 나의 API를 사용하게 됐다. 스펙과 프로토콜을 잘 정의해두면 의사소통에 시간을 많이 쏟지 않아도 된다는 게 신기했다. 그래도 가끔 질문은 들어왔는데 질문에 답변해주고 문서에 내용을 추가하는게 생각보다 재밌었다..

#### 리팩토링은 위험해

처음에는 V1 점포 등록 API에서 국가가 대만인 경우만 다르게 처리하는 방식도 고민을 했었다. 하지만 정확한 로직을 모르는 상태에서 코드에 손을 대는게 쉽지 않았다. 그래서 V2 API를 새로 만들기로 결정했다. V2 API는 새로운 클래스이기 때문에 비즈니스 로직도 V1 API를 참고하여 전부 새로 만들게 됐다. 인수인계를 받은 적이 없기 때문에 소스 코드를 볼 때마다 '이건 필요 없는 코드 같은데 왜 있는거지?' 라는 생각을 정말 많이 하게 됐다. 정확한 로직을 모르기 때문에 가급적이면 V1 코드에서 사용되는 코드를 거의 그대로 사용했고, 정말 필요 없을 것 같다 싶은 로직들만 V2에서 걷어냈다. 대부분은 걷어내도 문제없는 코드였지만, 그렇지 않은 코드도 있었다. BETA QA 시점에 전혀 예상치 못했던 부분에서 버그가 발생했고, 결국 제거했던 로직을 추가하게 됐다. BETA QA라 큰 문제는 없었지만, 기존 소스 코드를 수정하는 행동은 생각보다 만만치 않다는 걸 알게됐다. 지금은 어떤 로직이었는지 자세히 기억은 안나지만, 인수인계가 안되면 알 수가 없는 내용이었다. 이런 내용에는 꼭 주석을 달아줘야 겠다생각을 했고, 그 이후로 오해의 소지가 있는 부분에는 주석을 남기고 있다.

그리고 이미 배포가 된 기능을 리팩토링하게 되면 QA 리소스를 많이 확보해야 하므로 이 또한 고려해서 리팩토링을 해야 할지 말지에 대해 결정을 해야하겠구나. 라는 생각도 하게 됐다.

#### 기술 스택이 너무 많아

Merchant Map은 너무 과할정도로 다양한 기술의 집합체다. MongoDB, Elasticsearch, FeignClient, Kotlin 등 처음 접하는 기술들이 모여있었다. 당연히 이로 인해 러닝커브가 높아졌고, 개발할 때도 많은 지식이 필요하다. Phase1 에서는 기존 기능을 거의 그대로 사용하기 때문에 각 기술들에 대해 깊게 이해하지 못해도 상관없지만, 추후에 새로운 기능들을 추가해야 한다면 어느정도 기술에 대한 이해가 필요할 것 같다. 당장 중요한 MongoDB와 ES부터 공부해야겠다.