## 대만 App Pos 출시! - Line Pay Good Partner

### 기획

- 앱으로 가맹점의 거래 내역, 정산 내역 등을 조회할 수 있고, 결제 취소, 집계, 동향 등을 파악할 수 있는 관리 목적의 앱이다.

### 일정

- 개발 기간 : 21.03.21 ~ 21.06.10 (초기 추정공수 50MD)
- 투입 인력 : 3인
- Release : 2021.08.20 배포
- Service on: 2022.01.12 앱 출시

### 개발

개발은 크게 `인증`, `거래/정산 관리`, `점포/스태프 관리` 정도로 나뉘며, 하나의 파트를 맡아서 진행하게 됐다. 이 중에서 내가 맡은 부분은 `거래/정산 관리` 기능이다. 
거래내역 조회, 기간 별 통계, 거래 취소, 정산 내역 조회 등 거래와 정산 내역 관련 모든 기능을 구현한다.

### 회고

#### 의사소통은 신중하게

앞서 진행했던 과제들은 주로 기획, UI/UX, Web Dev팀과 주로 소통했다면, 이번 개발 과제는 참여 개발 팀만 Dev4, Web Dev, AOS, IOS, NTS이므로 무엇보다 소통이 중요하다고 생각했다. 예를 들어 API를 설계했을 때 AOS팀에서는 가능하다고 하지만, IOS팀에서는 불가능하다고 할 수도 있고 Web 팀과 App 팀 사이에 데이터를 주고받을 때 이슈가 있을 수도 있기 때문이다. 따라서 일방적으로 API Spec을 통보하기보단, 이렇게 설계되었을 때 문제가 없을 지 각 개발 팀에 문의를 하고 Sync를 맞추면서 진행했다. 똑같은 이유로 기획에 스펙 변경을 요구할 때에도 각 개발 팀이 인지할 수 있도록 멘션을 잊지않고 진행했다. 사소한 것까지 Sync를 맞추는 게 오버헤드일 수는 있지만, 기획과 개발팀 두 팀만 소통할 때에도 기획에 대한 오해로 구현이 상이한 경우가 제법 많은 걸 봐선 지속적으로 Sync를 맞추는게 현명한 방법이라고 생각한다. 그 증거로, 해당 기능은 4월에 개발 완료된 후로 사소한 변경 외에는 코드의 수정이 전혀 이루어지지 않았다. 다른 기능에 비해 비교적 변화가 적기 때문이기도 하겠지만, 처음부터 어느 팀에서도 문제되지 않도록 Sync가 맞춰져있었기 때문에 가능했던 일이라고 확신한다.

#### 성능 개선은 중요해

App Pos는 일본에 서비스를 하고 있고, 일본 앱에서 이미 `거래 내역 조회` API가 동작하고 있다. 따라서 대만 앱에서도 비슷하게 사용할 수 있을거라 생각했지만, 기획이 완전히 상이하여 완전히 새로운 API를 만들어야만 했다. 30일동안 발생한 거래내역을 Filtering해서 거래가 발생한 날짜만 보여주는 기능이 필요한데, Pos에 저장되는 거래내역이 하루에 60~70만 건으로 30일치를 한 번에 조회할 경우 성능이 안나오는 문제가 있다. 일자별로 거래내역을 보여줘야 하기 때문에 일자별로 거래를 묶어야하고 group by와 같은 작업을 수행하면 Slow API(3s 이상)가 되는 문제가 있다. 게다가 DB에는 JST 타임으로 저장되는 반면, 일자별로 조회하기 위해서는 TW timezone으로 변경해야 한다. 이렇게 되면 column에 대한 operation이 들어가기 때문에 DB가 인덱스를 타지 못 하거나 그루핑이 어려운 문제점이 있다.

이 부분을 개선하기 위해 약 3일 정도 쿼리를 여러 방면으로 튜닝하고, DBA에도 도움을 청했으나 별다른 개선점이 나오진 않았다. 구현이 불가능하다고 기획 팀에 요청해서 기획을 수정할 수도 있겠지만, 가능하면 기획이 요구한 스펙대로 구현하고 싶었다. 따라서 시간이 좀 오래 걸리더라도 Aggregation table을 만들기로 결정했다. 하루에 한 번 daily aggregation을 진행하는 job을 만들었고, daily aggregation 테이블을 이용해 조회하는 경우 API의 응답까지 10ms 정도 소요되는 짜릿함을 맛볼 수 있었다.

하지만 daily aggregation을 사용했을 때의 문제점도 존재한다. 자정에 배치가 바로 돌아간다고 해도, 자정에 바로 조회 시에는 daily aggregation에 집계되지 않은 날짜가 반드시 포함될 수 있다. 이 문제를 해결하기 위해 Service layer에서 daily aggregation으로 조회되지 않은 날짜들은 하루씩 개별 조회하도록 API를 개선했다. 코드 자체는 조금 복잡해졌으나, 부득이하게 배치가 돌지 않았다고 하더라도 퍼포먼스와 정합성 모두 잡을 수 있었다. 추후에 추가기획으로 6개월 거래 내역에 대한 리포트 요청이 들어왔는데, 이때는 daily aggregation이 존재하므로 monthly aggregation을 생성해 해결할 수 있었다. 이때도 monthly에 없으면 daily. daily에 없으면 10분 집계에서 조회해오도록 코드를 작성하여 정합성을 잃지 않도록 노력했다.

여태까지 해왔던 과제 중에 가장 도전적인 행동이었고 그 결과, 개발자로서도 서비스 성능 측면에서도 아주 만족스러운 결과를 얻은 것 같다. 이런 결과를 얻을 수 있게 여러 방면으로 조언을 해주신 새암님께 감사하게 생각한다.

#### 데이터 마이그레이션

Line Pay Good Partner 앱에서는 거래내역 조회 시에 결제가 발생한 플랫폼으로 필터링할 수 있는 기능이 있다. LINEPAY 내부 결제인지, wechat Pay결제인지, naver pay 결제인지, LINEPAY 해외 결제인지 등으로 필터링을 할 수 있다. 하지만 기존의 posdb에는 결제 플랫폼에 대한 정보가 없어, Central로부터 데이터를 마이그레이션해야만 하는 상황이 발생했다. 따라서 central-batch -> pos-consumer로 API를 만들어두고, batch에서 읽어들여 pos-consumer API를 호출하는 방식으로 마이그레이션을 진행했다. kafka를 이용한 동기화도 가능하지만 kafka를 이용하면 다른 컴포넌트에서도 consume이 발생하게 된다. 이때 다른 컴포넌트에서 idempotent한 동작으로 처리되고 있는지도 알 수 없고 로그가 무분별하게 쌓일 수 있기 때문에 다른 컴포넌트에 영향도가 없도록 API로 진행했다. RC 환경에서 API의 처리속도와 API 호출하는 쪽의 thread 수를 모니터링하면서 성능에 이슈가 없도록 설정했고, 약 2달 간의 꾸준한 마이그레이션을 통해 마이그레이션 작업을 끝낼 수 있었다. 즉, 2달 간 매일 아침 batch를 돌리고, disk나 cpu 등에 이슈가 없었는지 체크를 해야했으니 굉장히 tidious한 작업이었다.

MSA 설계의 장점은 정말 많지만, DB에 필요한 필드를 추가하는 과정이 생길 때마다 마이그레이션과 같은 작업을 수행해야 하고, 또는 누락 건이 있을 때 챙겨줘야 하는 운영상의 코스트가 있는 것 같다. 실제로 이 마이그레이션을 수행하는 동안 기존 스펙의 버그가 발견되어, 마이그레이션을 새로 돌려야 하는 상황이 발생했다. 그렇다고 쓰지도 않는 필드를 모두 다 저장하면 MSA의 장점을 살리지 못하는 꼴이고 필요한 필드만 저장하자니 기획이 변경될 때마다 마이그레이션을 수행해야 하니, 프로젝트의 방향성을 보고 필요한 데이터를 잘 선정해두는 것도 하나의 키포인트가 될 수 있을 것 같다. 물론 사업의 방향성을 개발 쪽에서 알기는 쉽지 않겠지만 말이다.. 이런 고민들은 명확한 정답은 없지만 본인의 경험과 회사의 특성을 종합해서 어느정도 노하우로 터득되지 않을까 싶다.

#### 정산은 어려워

거래 내역은 그나마 일본 App Pos API를 참고해서 취소나 결제의 flow를 어느정도 파악할 수는 있었다. 하지만 정산은 우리 팀 컴포넌트 어디에도 존재하지 않았고, API Spec을 봐도 이해하기가 너무 어려웠다. 팀원 분들도 정산 쪽에 대해서는 무지한 상태였기에 혼자 이 난관을 헤쳐나가야만 했다. 그나마 다행인 점은 기획에 나와있는 기능들이 Merchant Center에서 이미 사용 중인 기능들이라는 점이다. 그래서 NTS, Dev2, 기획팀의 지원을 받아서 해결을 하려 했으나 이마저도 쉽지 않았다. Dev2에서는 기획에 나와있는 값들이 어떤 의미를 갖는지 모르고 이해하지 못하는 상황이셨고, 기획에서도 내부적인 로직이 어떻게 되는지에 대해서는 전혀 모른다고 하셨다. NTS는 오래전에 개발된 소스 코드이고, 수정이 없었기에 논리적으로 설명이 불가능했다. 이 문제점을 해결하기 위해 Merchant Center의 settle쪽 소스코드를 전부 뜯어보고 동일한 동작을 하도록 우리 서비스에 맞춰서 리팩토링해서 구현했다. 코드에서 유추했을 때 '이월금액을 빼는 구나'와 같은 동작들을 유추할 수는 있지만, 정산에 대한 로직을 모르기 때문에 이게 맞는 로직인지 확인하는 게 어려웠다. 따라서 기획과 QA에는 최대한 꼼꼼하게 테스트해주길 요청드렸고, 나 또한 각종 테스트 시나리오를 만들어서 Center와 동일한 결과가 나오는지 수차례 검증했다. 주어진 상황에 맞춰, Center 쪽 코드에 맞춰서 개발을 진행하고 수 많은 테스트로 검증을 수행했지만 이 방법이 옳다고 생각하진 않는다. 하지만 다음에 또 이런 상황이 오게되면 어떻게 해야할 지 잘 모르겠다. PIC에게 요청해서 Dev2, 기획, Dev4, NTS 회의를 잡고 어떻게 코드를 짜야하는지 물어보는게 맞는 걸까?

