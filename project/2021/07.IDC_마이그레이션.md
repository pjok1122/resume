## IDC Migration (KR -> JP)

### 기획

- KR IDC를 전부 JP IDC로 옮기는 Line Pay 대규모 이사가 필요하다.

### 일정

- 개발 기간 : 21.07.01 ~ 21.09.10
- BETA QA : 21.06.09
- RC QA : 21.06.10
- 투입 인력 : 3인
- Release : 2021.09.14 이관, 2021.09.16 배포

### 개발

IDC 이관은 올해 안에 반드시 성공해야만 하는 Line Pay 필수 과제 중 하나다. IDC 이관은 총 3개의 Phase로 나누어서 수행되었고, benefit 컴포넌트는 Phase3에 해당되어 7월부터 조금씩 작업을 진행했다. 

#### 사전 작업 목록

1. nClavis 3.0 이전
2. Rabbit MQ -> Kafka 전환
3. membership API 제거
4. ACL 확인 및 요청
5. Redis migration test
6. BETA 환경 설정
7. BETA 환경 테스트
8. RC, REAL 환경 설정
9. 신규 Batch Jenkins 셋업
10. 성능테스트
11. OBS migration

### 회고

#### 팀워크

IDC 이관은 실수가 있으면 장애로 이어지는 아주 꼼꼼한 확인이 필요한 작업이다. 따라서 IDC 이관을 준비하는 인력이 새로운 개발과제를 진행하는 건 타당하지 않다. 하지만, 모든 사업 프로젝트가 IDC 이관을 기다려주지는 않는다. 따라서 일부 인력은 sus 개발과 유지보수에 인력을 투입해야 했다. benefit은 정훈님이 migration의 책임을 가지고 있었고, 새암님은 NTS의 migration을 챙겨야 했기에 남은 인력인 내가 모든 sus건들을 쳐내야 하는 상황이었다. 보통은 신규 과제를 잡진 않지만 app pos는 신규 런칭을 준비하는 과정이기에 QA를 통해 등록되는 버그가 지속적으로 올라왔고, 머천트맵도 Frontend 분리라는 작업 과정에서 서버 쪽 대응이 일부 필요한 상황이었다. 다행이도 여태 대부분의 컴포넌트 경험이 있어 시간은 좀 걸리더라도 대부분 혼자서 해결할 수 있었다. benefit component에 대한 이해도가 가장 높은 정훈님께서 기능 위주의 마이그레이션을 수행해주셨고, 나는 ACL 확인 및 요청, nClavis 3.0 이전, 성능테스트, batch jenkins migration, obs migration, migration 후 모니터링 및 대응 등의 작업을 수행했다.

실질적인 개발 인력은 2명밖에 존재하지 않는데 신입사원이 충원되어 신입사원까지 케어해야 하는 아주 힘든 상황이었지만 전우애(?) 같은 걸 느꼈다. 내가 힘든만큼 다른 팀원들도 힘들 거라 생각했고, 내가 할 수 있는 부분은 최대한 더 맡아서 진행하려 했다. 재택근무 환경으로 인해 팀원과의 유대감과 소속감은 높지 않았지만, 나의 이런 행동들이 팀원들의 짐을 덜어줬다고 확신하고 있다. 다시 이런 상황을 마주하더라도 내가 할 수 있는 부분에 대해서는 최선을 다할 생각이다.

#### IDC 이관에 대한 경험

IDC이관은 달리는 차에서 다른 차로 갈아타는 작업과 같다. 이때 언제든 다시 갈아탈 수 있도록 미리 다 준비해두어야 한다. 서비스를 장시간 죽이고 이전한다면 상대적으로 쉬운 작업이겠지만, 라인페이 같이 서비스 규모가 큰 경우 서비스를 장시간 이용하지 못한다는 것은 치명적이기 때문에 이와 같은 절차들이 필요하다.

첫 번째로, Redis 같은 장비에는 Dual write 같은 설정을 해둬야 한다. Redis key, value가 서비스에 영향을 줄 수 있는 데이터가 저장된다면, 롤백 시에 문제가 될 수 있으므로 초기에는 Redis 두 군데에 dual write를 하는 방식으로 진행한다. 그 외에도 nDeploy 배포 시나리오를 설정해둔다거나 배포 시간을 최대한 줄이기 위한 빌드 작업을 미리 해둔다거나 하는 절차가 필요하다. 이러한 작업들은 장애의 지속 시간을 최대한 줄이기 위함이다.

두 번째로, MSA 구성이기 때문에 각 서버 간의 ACL 신청도 아주 많이 필요하다. 단 하나의 ACL에 누락이라도 발생하는 경우 장애로 이어지기 때문에 꼼꼼하게 더블 체크로 진행했다. 모든 컴포넌트가 같은 zone에 속한다면 ACL 작업도 상대적으로 간단하겠지만 금융 서비스답게 여러 zone이 존재하기 때문에 ACL 작업이 매우매우 중요한 작업 중 하나였다. 

세 번째로, 장비가 전부 바뀌기 때문에 성능에 대한 충분한 테스트가 필요하다. 테스트는 JP 장비에서 nGrinder를 통해 진행했다. 스크립트는 groovy 코드로 작성했고, 실제 리얼 환경의 로그를 바탕으로 테스트하려는 API들의 호출 비율을 반영해서 실제 리얼 환경에서 문제가 없을 지 확인했다. 추가로 Vuser를 조절해서 호출하고 반복적으로 호출했을 때, TPS가 일정수준으로 유지되는지도 확인이 필요하다. 첫 번째 테스트에는 그래프가 우하향 하는 모습을 띄었으나, API 동작을 봤을 때 어느정도의 우하향은 나올 수 있는 그래프였다. 하지만 정확한 측정을 위해 테스트에 방해가 되는 API를 제거하고 다시 두 번째 테스트를 수행했다. 이때, TPS가 순간적으로 튀는 현상이 일부 발생했다. 잦은 GC로 인해 발생하는 것으로 보였으나 좀 더 정확한 측정을 위해 pinpoint를 붙여 세밀한 모니터링을 진행했고, memory 변경과 CMS GC에서 G1GC로 변경하는 등의 설정과정 끝에 마이그레이션에 문제 없음을 결론 지을 수 있었다. 

성능테스트와 pinpoint를 붙이는 작업까지는 내가 진행했다. 설정을 바꿔가며 nGrinder를 돌리는 과정이 제법 부담스러운 과제였다. 잘못된 분석을 할 수도 있고, 잘못된 테스트를 수행해 이상한 지표를 읽을 수도 있었기 때문이다. 보다 심도있는 테스트를 위해서 pinpoint 설정 이후부터는 시니어분께서 분석하고 설정을 변경해주셨다. 시간과 공간의 제약때문에 바로 옆에서 보고 배운 건 아니지만, 자료와 슬랙 대화를 통해 어깨너머로 지표를 어떻게 읽고 분석하는지 배울 수 있었다. IDC 이관은 대부분의 회사에서 경험하지 못하는 특별한 작업이다. 게다가 주니어 개발자인 내가 IDC 이관에 참여할 수 있는 기회가 주어질 확률은 더욱 더 희박하다. 인력 부족으로 매우 힘든 시기였지만, 돌이켜보면 이런 작업을 통해 한층 더 성장할 수 있었기에 이런 기회에 감사하게 생각한다.

#### 당일 모니터링

IDC 이전 작업은 나머지 두 팀원이 진행하셨고, 나는 아침 8시에 교대하여 그때부터 모니터링과 QA 대응을 진행했다. 다행이도 real 환경에서는 이슈가 되는 부분은 없었다. 하지만 커뮤니케이션에 문제가 있었는지 RC에 대한 마이그레이션은 이루어지지 않았는데 RC QA가 시작되어 많은 혼선이 있었다. 결국 팀원이 주무시는 동안 RC에 대한 migration을 진행했다. real과 달리 실제 서비스 환경은 아니므로 작업에 큰 부담이 되지는 않으나, IDC 이관에 아예 involved 되어있지 않았다면 어떤 부분을 확인해야하고 수정해야 하는지 알지 못했을 것 같다. 아무래도 benefit에 대한 이해도가 다른 컴포넌트에 비해 떨어지기 때문에 꽤 많은 삽질이 있긴 했으나, 팀원 분들 새벽에 고생하고 쉬시는데 방해하고 싶진 않았다. 조금 끙끙대긴 했으나, 대부분 ACL 문제거나 host 설정 이슈였기에 문제없이 수정할 수 있었다.