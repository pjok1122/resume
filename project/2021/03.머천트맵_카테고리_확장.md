## Merchant Map 카테고리 개편 & 마이그레이션

### 기획을 이해하기 위한 서비스 간략 정리

- 머천트맵은 각 점포를 카테고리 별로 분류하여 노출하고 있다.
- 글로벌 공통 스펙으로 시작했기 때문에 각 국가는 모든 카테고리를 공유해서 사용하고 있었다.

### 기획

- 대만에서 자체적으로 카테고리를 추가하고, 해당 카테고리는 대만 머천트맵에서만 노출되기를 원한다.
- 기존의 점포 중 일부를 신규 카테고리로 마이그레이션 하기를 원한다.

### 일정

- 개발 기간 : 21.02.16 ~ 21.03.05
- 투입 인력 : 1인
- BETA QA : 03.08 ~ 03.12
- RC QA : 03.15 ~ 03.18
- Release : 2021.03.25 배포

### 개발

- 당장 국가별 카테고리를 분류하는 것이 어렵기 때문에 각 국가별로 카테고리가 노출될지 말지 여부를 3bits 안에 담아내고, bit operation으로 노출 유무를 판단하기로 결정하기로 했다.
  - ex) JP, TW, TH --> 101 : JP에 노출, TH에 노출.
- 카테고리 마이그레이션을 위한 배치 Job 개발.
- 카테고리 노출 유무를 bit operation으로 API 수정.
- 카테고리와 점포 정보들은 캐시가 되고 있어, 각 마이그레이션 절차와 예상 소요 시간을 문서화 하고 새벽에 마이그레이션을 진행. (Rollback Plan 작성)
  - (사전 작업) 신규 카테고리 등록 -> XLT 등록
  - (사후 작업) 신규 카테고리 노출 유무 설정 -> 카테고리 캐시 삭제 -> MerchantMap Server 재시작 -> 카테고리 매핑 관계 변경(심사->노출) -> 카테고리 점포 마이그레이션 -> 점포 정보 캐시 삭제

<hr>

### 회고

#### 실패의 경험

위 작업은 실제 마이그레이션 당일 날 실패를 경험했다. 위의 `사후작업` 절차에서 `서버 재시작`을 하지 않고 진행했었는데 머천트맵에 점포 추가 시에 신규 카테고리로 매핑이 되지 않았다. 결국, 롤백 플랜에 따라 롤백을 진행하고 새벽 4시에 잠을 청하게 됐다..
다른 걸 다 떠나서 QA, 기획, 글로벌 마케팅팀에서 함께 모니터링을 진행해주고 있었는데 이들의 시간을 뺏었다는 미안함이 컸다. **새벽에도 자는 내내 뭐가 문제였을 지 고민하다 잠들었고, 꿈 속 디버깅을 통해 원인을 찾아버렸다.**
소스 코드를 꼼꼼하게 확인하지 못했던 것이 원인이었다. 일부 소스 코드에서 `@PostConstruct`를 통해 메모리에 카테고리를 올려놓고 사용하고 있었다. 이 코드 때문에 서버 재시작이 불가피하게 필요했던 것이다.
다음 날 아침 바로 BETA 환경에서 테스트를 진행해서 동작에 문제가 없음을 Sanity test를 통해 검증한 후, 같은 시각에 Hotfix를 진행했다. 이번엔 문제 없이 성공적으로 반영이 되었다.
그 전날도 서버만 재시작했다면 문제가 없었을 거라는 허탈감도 느꼈지만, **꼼꼼하게 확인하지 못한 내 잘못으로 인해 많은 이들의 시간을 뺏을 수도 있다는 것을 한 번 더 배웠다.**

<br>

#### 완벽한 대비!

이번 과제에서 좋았던 점도 분명히 있다. 그 중에서도 **가장 좋았던 점은 절차를 문서화했다는 점이다.** 문서화로 인해 놓치는 작업 없이 순서대로 진행할 수 있었고, QA, 기획 등 다른 팀에서도 해당 문서를 보며 현재 어떤 프로세스를 진행하고 있는지를 완벽히 이해할 수 있었다.
문서에는 대략적인 소요 시간을 러프하게 잡아두었기에 시간에 쫓길 일도 없었고, 언제 쯤 작업이 종료될 지도 거의 들어맞았다. 또한 rollback에 대한 플랜도 세워두지 않았다면, 첫날 실패했을 때 어떻게 처리해야할 지 당황했을 게 분명하다. 롤백에 대한 플랜이 있었기에 좀 더 자신감을 가지고 진행할 수 있었다. 문서화가 꼭 귀찮고 번거로운 작업만은 아니라는 것을 다시 한 번 몸으로 배울 수 있었다. 이 문서는 나중에 다시 카테고리 관련 작업을 해야 할 때 이 문서를 보면 해당 내용에 대한 리마인드가 빠르게 될 것이라 확신하고, 내가 아닌 다른 개발자가 작업한다 한들 큰 도움이 될 거라 믿는다.

<br>

#### 개선의 필요성

`@PostConsturct`를 이용하면 분명 성능상 장점이 많다. 하지만 이번 경험을 통해서 알게 된 건, 정기배포 시기가 아닌 시점에 작업이 계속해서 추가될 수 있다면 `@PostConstruct`를 사용하는게 능사는 아니라는 것을 배웠다.
가령 위의 상황처럼 카테고리가 언제든지 추가가 될 수 있고, 그 즉시 반영이 되길 원한다면 `@PostConstruct` 보단 레디스 캐시를 통해 데이터를 저장해두는 것이 좋다고 생각하게 됐다. 이 부분은 추후에 개선을 진행할 예정이다.

위의 `사후 작업` 중 가장 마지막 절차인 `점포 정보 캐시 삭제`는 전체 점포에 대한 캐시 정보를 리프레시하는 작업인데 무려 2시간에 가까운 시간이 걸린다. 이는 머천트맵이 유저에게 뿌려주는 DTO 자체를 19개의 언어에 맞춰 캐시를 하기 때문에 그 양이 방대하기 때문이다.
DTO 생성 과정 자체가 복잡하고 시간이 많이 소요되기 때문에 한 번 캐시에 만들어놓고, 변경이 없다면 24시간 내내 동일한 데이터로 사용하려던 의도로 보였다. 여태까지는 성능에는 큰 문제가 없었기 때문에 방치해두었으나, 이번 카테고리 개선 작업 과정처럼 매번 캐시를 삭제해야 한다면 이 또한 문제가 있다는 생각이 들었다. 점포의 수는 앞으로도 계속 늘어날 예정인데, 캐시 리프레시의 시간이 사용자가 적은 오전 시간대를 넘어선다면 문제가 생길 수 밖에 없었다.
그래서 검토한 결과, 점포를 조회하는 일부 코드를 개선하고 캐시 시간은 5~10분 정도로 줄이기로 결정했다.